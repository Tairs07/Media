# MediaShare 项目部署文档

## 目录
- [环境要求](#环境要求)
- [部署方式](#部署方式)
  - [方式一：在服务器上直接构建（推荐）](#方式一在服务器上直接构建推荐)
  - [方式二：本地构建后上传](#方式二本地构建后上传)
- [配置说明](#配置说明)
- [常用命令](#常用命令)
- [故障排查](#故障排查)

## 环境要求

### 服务器配置
- 操作系统：Linux (Ubuntu 20.04+ / CentOS 7+ / Debian 10+)
- CPU：2核心以上
- 内存：2GB以上
- 硬盘：20GB以上可用空间

### 软件要求
- Docker 20.10+
- Docker Compose 2.0+

## 部署方式

### 方式一：在服务器上直接构建（推荐）

这种方式适合服务器性能较好的情况，直接在服务器上拉取代码并构建。

#### 1. 安装Docker和Docker Compose

```bash
# 更新系统
sudo apt-get update

# 安装Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# 安装Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# 验证安装
docker --version
docker-compose --version

# 将当前用户添加到docker组（避免每次都用sudo）
sudo usermod -aG docker $USER
# 重新登录使其生效
```

#### 2. 上传项目代码到服务器

```bash
# 方法1：使用git
cd /opt
sudo git clone <你的代码仓库地址>
cd <项目目录>

# 方法2：使用scp上传
# 在本地执行
scp -r ./MediaShare root@your-server-ip:/opt/
```

#### 3. 配置环境变量

```bash
# 修改后端生产环境配置
cd /opt/<项目目录>/backend
vim appsettings.Production.json

# 修改以下配置：
# 1. Jwt.Key：修改为安全的密钥（至少32字符）
# 2. Cors.AllowedOrigins：添加你的域名或IP

# 修改前端环境变量
cd /opt/<项目目录>/frontend
vim .env.production

# 修改 VITE_API_BASE_URL 为你的服务器地址
# 例如：VITE_API_BASE_URL=http://192.168.1.100:5000
# 或：VITE_API_BASE_URL=http://your-domain.com:5000
```

#### 4. 修改docker-compose.yml

```bash
cd /opt/<项目目录>
vim docker-compose.yml

# 修改前端构建参数中的 VITE_API_BASE_URL
# 将 your-server-ip 替换为实际的服务器IP或域名
```

#### 5. 启动服务

```bash
# 构建并启动所有服务
docker-compose up -d --build

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f
```

#### 6. 验证部署

```bash
# 检查后端健康状态
curl http://localhost:5000/api/health

# 访问前端
# 在浏览器打开：http://your-server-ip
```

### 方式二：本地构建后上传

这种方式适合服务器性能较弱的情况，在本地构建好后上传到服务器。

#### 1. 本地构建后端

```bash
# 在Windows上打开PowerShell或Git Bash
cd E:\LLJ\backend

# 构建发布文件
dotnet publish -c Release -o publish

# 打包发布文件
tar -czf backend-publish.tar.gz publish/
# 或在Windows上使用7zip压缩为backend-publish.zip
```

#### 2. 本地构建前端

```bash
cd E:\LLJ\frontend

# 修改环境变量
# 编辑 .env.production 文件，设置正确的API地址

# 安装依赖（如果还没安装）
npm install

# 构建
npm run build

# 打包构建文件
tar -czf frontend-dist.tar.gz dist/
# 或在Windows上使用7zip压缩为frontend-dist.zip
```

#### 3. 上传到服务器

```bash
# 创建部署目录
ssh root@your-server-ip "mkdir -p /opt/mediashare/backend /opt/mediashare/frontend"

# 上传文件
scp backend-publish.tar.gz root@your-server-ip:/opt/mediashare/backend/
scp frontend-dist.tar.gz root@your-server-ip:/opt/mediashare/frontend/

# 上传Docker配置文件
scp backend/Dockerfile.prod root@your-server-ip:/opt/mediashare/backend/
scp backend/.dockerignore root@your-server-ip:/opt/mediashare/backend/
scp frontend/Dockerfile.prod root@your-server-ip:/opt/mediashare/frontend/
scp frontend/nginx.conf root@your-server-ip:/opt/mediashare/frontend/
scp docker-compose.prod.yml root@your-server-ip:/opt/mediashare/
```

#### 4. 在服务器上解压

```bash
# 登录服务器
ssh root@your-server-ip

cd /opt/mediashare

# 解压后端
cd backend
tar -xzf backend-publish.tar.gz
# 或：unzip backend-publish.zip

# 解压前端
cd ../frontend
tar -xzf frontend-dist.tar.gz
# 或：unzip frontend-dist.zip

cd ..
```

#### 5. 创建数据目录

```bash
cd /opt/mediashare

# 创建数据目录
mkdir -p data/uploads/images data/uploads/videos data/uploads/thumbnails

# 如果有现有数据库，上传到这里
# scp MediaShareDB.db root@your-server-ip:/opt/mediashare/data/
```

#### 6. 启动服务

```bash
cd /opt/mediashare

# 使用生产环境配置启动
docker-compose -f docker-compose.prod.yml up -d --build

# 查看服务状态
docker-compose -f docker-compose.prod.yml ps

# 查看日志
docker-compose -f docker-compose.prod.yml logs -f
```

## 配置说明

### 端口配置

默认端口配置：
- 前端：80 (HTTP)
- 后端：5000

如需修改端口，编辑 `docker-compose.yml`：

```yaml
services:
  frontend:
    ports:
      - "8080:80"  # 将前端端口改为8080
  backend:
    ports:
      - "5001:5000"  # 将后端端口改为5001
```

### 防火墙配置

```bash
# Ubuntu/Debian
sudo ufw allow 80/tcp
sudo ufw allow 5000/tcp
sudo ufw reload

# CentOS/RHEL
sudo firewall-cmd --permanent --add-port=80/tcp
sudo firewall-cmd --permanent --add-port=5000/tcp
sudo firewall-cmd --reload
```

### 数据持久化

项目数据存储在以下位置：
- 数据库：`./data/MediaShareDB.db` (方式二) 或 `./backend/MediaShareDB.db` (方式一)
- 上传文件：`./data/uploads/` (方式二) 或 `./backend/wwwroot/uploads/` (方式一)

建议定期备份这些目录。

### HTTPS配置（使用Let's Encrypt）

如果需要配置HTTPS，推荐使用Nginx反向代理：

```bash
# 安装Certbot
sudo apt-get install certbot python3-certbot-nginx

# 获取SSL证书
sudo certbot --nginx -d your-domain.com

# 配置自动续期
sudo certbot renew --dry-run
```

或使用Docker Nginx Proxy：

```bash
# 可以考虑使用 nginx-proxy + letsencrypt-companion
# 参考：https://github.com/nginx-proxy/nginx-proxy
```

## 常用命令

### Docker Compose命令

```bash
# 启动服务
docker-compose up -d

# 停止服务
docker-compose down

# 重启服务
docker-compose restart

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f [service_name]

# 重新构建并启动
docker-compose up -d --build

# 仅重新构建某个服务
docker-compose up -d --build frontend
```

### Docker命令

```bash
# 查看运行中的容器
docker ps

# 查看所有容器
docker ps -a

# 查看容器日志
docker logs -f <container_id_or_name>

# 进入容器
docker exec -it <container_id_or_name> /bin/sh

# 查看镜像
docker images

# 删除未使用的镜像
docker image prune -a

# 查看容器资源占用
docker stats
```

### 数据库操作

```bash
# 进入后端容器
docker exec -it mediashare-backend /bin/bash

# 查看数据库（需要安装sqlite3）
apt-get update && apt-get install -y sqlite3
sqlite3 MediaShareDB.db
# 在sqlite中执行SQL
.tables
.schema Users
SELECT * FROM Users;
.quit
```

### 备份与恢复

```bash
# 备份数据
sudo tar -czf backup-$(date +%Y%m%d).tar.gz data/

# 恢复数据
sudo tar -xzf backup-20250101.tar.gz
```

## 故障排查

### 1. 容器无法启动

```bash
# 查看详细日志
docker-compose logs backend
docker-compose logs frontend

# 检查容器状态
docker-compose ps
```

### 2. 前端无法访问后端

检查：
1. 后端容器是否正常运行
2. 网络配置是否正确
3. 防火墙是否开放端口
4. 前端环境变量中的API地址是否正确

```bash
# 测试后端连通性
curl http://localhost:5000/api/health

# 在前端容器内测试
docker exec -it mediashare-frontend /bin/sh
wget -O- http://backend:5000/api/health
```

### 3. 文件上传失败

检查：
1. 上传目录权限是否正确
2. 容器挂载卷是否正确
3. 文件大小限制配置

```bash
# 检查目录权限
docker exec -it mediashare-backend ls -la /app/wwwroot/uploads

# 如果权限不对，修复权限
docker exec -it mediashare-backend chmod -R 755 /app/wwwroot/uploads
```

### 4. 数据库连接失败

```bash
# 检查数据库文件是否存在
docker exec -it mediashare-backend ls -la /app/MediaShareDB.db

# 检查数据库文件权限
docker exec -it mediashare-backend chmod 666 /app/MediaShareDB.db
```

### 5. 内存不足

```bash
# 查看资源占用
docker stats

# 清理未使用的资源
docker system prune -a --volumes
```

### 6. 查看详细错误

```bash
# 查看实时日志
docker-compose logs -f --tail=100

# 进入容器检查
docker exec -it mediashare-backend /bin/bash
docker exec -it mediashare-frontend /bin/sh
```

## 性能优化建议

1. **使用Nginx作为反向代理**：在生产环境建议在宿主机安装Nginx作为反向代理
2. **启用Gzip压缩**：前端已配置，确保生效
3. **配置CDN**：对静态资源使用CDN加速
4. **数据库优化**：定期维护数据库，考虑使用PostgreSQL或MySQL替代SQLite
5. **监控告警**：使用Prometheus + Grafana监控服务状态

## 安全建议

1. **修改默认密钥**：必须修改 `appsettings.Production.json` 中的JWT密钥
2. **使用HTTPS**：生产环境务必配置SSL证书
3. **限制CORS**：在 `appsettings.Production.json` 中只允许信任的域名
4. **定期更新**：定期更新Docker镜像和依赖包
5. **备份策略**：建立定期备份机制
6. **防火墙**：配置防火墙规则，只开放必要端口

## 更新部署

### 使用方式一更新

```bash
cd /opt/<项目目录>
git pull
docker-compose down
docker-compose up -d --build
```

### 使用方式二更新

```bash
# 本地重新构建
# 上传新的构建文件
# 在服务器上执行
cd /opt/mediashare
docker-compose -f docker-compose.prod.yml down
# 解压新文件
docker-compose -f docker-compose.prod.yml up -d --build
```

## 监控和日志

### 查看日志

```bash
# 查看所有服务日志
docker-compose logs -f

# 查看特定服务日志
docker-compose logs -f backend

# 查看最近100行日志
docker-compose logs --tail=100 frontend
```

### 健康检查

```bash
# 检查后端健康状态
curl http://localhost:5000/api/health

# 查看Docker健康状态
docker inspect --format='{{.State.Health.Status}}' mediashare-backend
```

## 联系支持

如遇到问题，请检查：
1. 日志文件
2. Docker容器状态
3. 网络连接
4. 防火墙配置

---

**祝部署顺利！**
