# 文件存储方案设计

## 存储方案选择

### 开发环境
- **方案**: 本地文件系统存储
- **路径**: `wwwroot/uploads/`
  - 图片: `wwwroot/uploads/images/`
  - 视频: `wwwroot/uploads/videos/`
  - 缩略图: `wwwroot/uploads/thumbnails/`

### 生产环境（推荐）
- **方案**: 云存储服务
  - 阿里云 OSS (Object Storage Service)
  - 腾讯云 COS (Cloud Object Storage)
- **优势**: 
  - 高可用性和可扩展性
  - CDN 加速
  - 自动备份和容灾

## 文件命名规则

### 格式
```
{UserId}_{Timestamp}_{RandomString}.{Extension}
```

### 示例
```
1_20241031100000_a3f5b2.jpg
1_20241031100000_a3f5b2_thumb.jpg
```

### 目录结构
```
uploads/
├── images/
│   ├── 2024/
│   │   └── 10/
│   │       └── 31/
│   │           └── 1_20241031100000_a3f5b2.jpg
├── videos/
│   └── [类似结构]
└── thumbnails/
    └── [类似结构]
```

## 文件类型限制

### 图片格式
- `image/jpeg`
- `image/png`
- `image/gif`
- `image/webp`

### 视频格式
- `video/mp4`
- `video/webm`
- `video/quicktime`

### 大小限制
- 图片: 最大 10MB
- 视频: 最大 100MB

## 缩略图生成

### 图片缩略图
- 尺寸: 300x300 (保持宽高比)
- 质量: 80%
- 格式: JPEG

### 视频缩略图
- 从视频第1秒提取帧
- 尺寸: 300x300
- 格式: JPEG

## 存储接口设计

### IFileStorageService 接口

```csharp
public interface IFileStorageService
{
    Task<string> SaveFileAsync(IFormFile file, int userId, string fileType);
    Task<string> SaveThumbnailAsync(string sourcePath, int userId);
    Task<bool> DeleteFileAsync(string filePath);
    Task<Stream> GetFileAsync(string filePath);
    string GetFileUrl(string filePath);
}
```

### 本地存储实现

- 检查文件类型和大小
- 生成唯一文件名
- 保存到本地目录
- 返回相对路径

### 云存储实现（未来）

- 上传到OSS/COS
- 配置CDN域名
- 返回公开访问URL

## 安全措施

1. **文件类型验证**: 检查文件扩展名和MIME类型
2. **大小限制**: 防止上传过大文件
3. **文件名清理**: 防止路径遍历攻击
4. **权限控制**: 私有文件需要认证
5. **病毒扫描**: 生产环境建议集成病毒扫描服务

## 配置项

在 `appsettings.json` 中配置：

```json
{
  "FileStorage": {
    "Type": "Local", // Local 或 Cloud
    "LocalPath": "wwwroot/uploads",
    "MaxImageSize": 10485760, // 10MB
    "MaxVideoSize": 104857600, // 100MB
    "AllowedImageTypes": ["image/jpeg", "image/png", "image/gif", "image/webp"],
    "AllowedVideoTypes": ["video/mp4", "video/webm", "video/quicktime"],
    "ThumbnailWidth": 300,
    "ThumbnailHeight": 300
  }
}
```




